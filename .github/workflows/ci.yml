name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-chains:
    name: Validate Attack Chains
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate all chains
      run: |
        python3 -c "
        import sys
        import os
        sys.path.insert(0, os.getcwd())
        from chains.chain_analyzer import ChainAnalyzer
        import json
        import glob
        
        analyzer = ChainAnalyzer()
        
        # Load all chain JSON files
        chain_files = glob.glob('chains/chain_templates/exports/*.json')
        chain_files.extend(glob.glob('targets/**/*.json', recursive=True))
        
        errors = []
        for chain_file in chain_files:
            try:
                chain = analyzer.import_chain(chain_file)
                is_valid, issues = chain.validate_chain()
                if not is_valid:
                    errors.append(f'{chain_file}: {issues}')
            except Exception as e:
                errors.append(f'{chain_file}: {str(e)}')
        
        if errors:
            print('Chain validation errors:')
            for error in errors:
                print(f'  - {error}')
            sys.exit(1)
        else:
            print('All chains validated successfully!')
        "
    
    - name: Run chain tests
      run: |
        if [ -f "chains/test_validation.py" ]; then
          python3 chains/test_validation.py
        fi
    
    - name: Check Python syntax
      run: |
        python3 -m py_compile chains/*.py targets/**/*.py automation/*.py 2>&1 || true

  generate-reports:
    name: Generate Test Reports
    runs-on: ubuntu-latest
    needs: validate-chains
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate sample report
      run: |
        python3 -c "
        import sys
        import os
        sys.path.insert(0, os.getcwd())
        from chains.chain_analyzer import ChainAnalyzer, ChainStep, VulnerabilityType, ImpactLevel
        from chains.report_generator import ReportGenerator
        
        analyzer = ChainAnalyzer()
        chain = analyzer.create_chain(
            title='CI/CD Test Chain',
            description='Test chain for CI/CD validation',
            impact=ImpactLevel.MEDIUM
        )
        
        step1 = ChainStep(1, VulnerabilityType.XSS, 'Test XSS', outcome='XSS found')
        chain.add_step(step1)
        
        generator = ReportGenerator()
        report = generator.generate_executive_summary(chain)
        print('Report generated successfully!')
        print(report[:200])
        "
    
    - name: Upload reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-reports
        path: |
          docs/exports/*.html
          docs/exports/*.pdf
          docs/exports/*.docx
        if-no-files-found: ignore

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install linting tools
      run: |
        pip install flake8
    
    - name: Run flake8
      run: |
        flake8 chains/ targets/ automation/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 chains/ targets/ automation/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
